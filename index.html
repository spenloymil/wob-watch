<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WOB WATCH+ — Stream</title>

<!-- Anton font (Impact-like) -->
<link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
<!-- hls.js for HLS manifest playback -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  :root{
    --accent:#004d29;
    --accent-2:#00553a;
    --bg-1:#04130f;
    --bg-2:#061a12;
    --card:#07261a;
    --muted:#9ec7b0;
    --maxw:1300px;
    --radius:14px;
    --card-radius:22px;
    --badge-bg:#ffd166;   /* warm gold to stand out */
    --badge-fg:#033d2a;   /* deep green for contrast */
    --status-bg: rgba(255,255,255,0.06);
    --status-fg: #9ec7b0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    color:#e8f8ef;
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    -webkit-font-smoothing:antialiased;
  }

  /* ===== Welcome ===== */
  #welcome {
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, #043b2b, #02261a);
    color:white; flex-direction:column; gap:14px; text-align:center; padding:28px;
  }
  #welcome .logoLarge{
    width:160px;height:160px;border-radius:16px;
    display:flex;align-items:center;justify-content:center;font-weight:900;font-size:48px;
    background:linear-gradient(180deg,#055b3e,#044733);
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    overflow:hidden;
  }
  #welcome .logoLarge img{ width:100%; height:100%; object-fit:contain; display:block }
  #welcome h1{margin:0;font-size:28px}
  #welcome p{margin:0;color:rgba(255,255,255,0.95);max-width:740px}
  #welcome .startBtn{margin-top:8px;padding:12px 18px;border-radius:10px;background:white;color:var(--accent);font-weight:800;cursor:pointer;border:0}
  .hide-welcome{ animation: fadeOut .35s forwards; }
  @keyframes fadeOut { to { opacity:0; transform:translateY(-6px) scale(.995); visibility:hidden } }

  /* ---------- Header ---------- */
  .topbar{
    display:flex;align-items:center;gap:14px;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.03);
    background: linear-gradient(90deg, rgba(0,77,41,0.04), transparent); position:sticky; top:0; z-index:60;
  }
  #logo { width:48px;height:48px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;color:#fff }
  #logo img{ width:100%;height:100%;object-fit:cover;display:block }
  .brand { display:flex; flex-direction:column }
  .brand .title{ font-family: 'Anton', Impact, Haettenschweiler, "Arial Black", sans-serif; color:var(--accent); font-weight:900; letter-spacing:0.6px; }
  .brand .sub{ color:var(--muted); font-size:12px }
  .header-actions{ margin-left:auto; display:flex; gap:12px; align-items:center }
  .btn { background:var(--accent); color:white; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:7px 10px; border-radius:8px }

  /* ---------- Layout ---------- */
  main { max-width:var(--maxw); margin:18px auto; padding:0 18px 80px; }
  .layout { display:block; gap:22px; align-items:start; }

  /* Search results block */
  .searchResults {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:12px;
    margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.45);
  }
  .searchHeader { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
  .searchHeader .count { color:var(--muted); font-size:13px; margin-left:auto }
  .resultsGrid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(210px,1fr)); }

  /* HOME GRID: portrait cards */
  .homeGrid{ display:grid; gap:18px; margin-bottom:18px; }
  .card {
    background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.06));
    border-radius:var(--card-radius);
    overflow:hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    cursor:pointer;
    display:flex; flex-direction:column;
    position:relative;
  }
  .cardImage{
    position:relative; width:100%; padding-top:160%;
    background:#777; display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .cardImage img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; display:block; }
  .cardPlaceholder{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#222; font-weight:800; font-size:22px; background:#999; }
  .thumbPlaceholder{ display:flex; align-items:center; justify-content:center; color:#222; font-weight:900; background:#999; border-radius:8px; }
  .cardFooter{
    padding:14px; background:var(--accent); color:white; display:flex; flex-direction:column; gap:6px; align-items:center; text-align:center;
  }
  .cardFooter .title{ font-family:'Anton', Impact, sans-serif; font-size:22px; letter-spacing:0.6px; }
  .cardFooter .sub{ font-size:13px; color:rgba(255,255,255,0.9); }

  /* show badge on card image (centered) */
  .showBadge{
    position:absolute;
    top:14px;
    left:50%;
    transform:translateX(-50%);
    background:var(--badge-bg);
    color:var(--badge-fg);
    font-weight:800;
    font-size:12px;
    padding:6px 12px;
    border-radius:999px;
    letter-spacing:0.6px;
    box-shadow:0 8px 22px rgba(0,0,0,0.45);
    text-transform:uppercase;
    z-index:6;
    white-space:nowrap;
  }

  /* hero cover should allow absolute overlays */
  .heroCover{ position:relative; }
  .heroCover img{ width:100%; height:100%; object-fit:cover; display:block }

  /* hero badge (corner) */
  .heroBadge{
    position:absolute;
    top:10px;
    right:10px;
    background:var(--badge-bg);
    color:var(--badge-fg);
    font-weight:800;
    font-size:11px;
    padding:6px 8px;
    border-radius:999px;
    box-shadow:0 8px 18px rgba(0,0,0,0.36);
    text-transform:uppercase;
    z-index:6;
    white-space:nowrap;
  }

  /* hero status badge for unpublished/hidden */
  .heroStatusBadge{
    position:absolute;
    top:10px;
    left:10px;
    background:var(--status-bg);
    color:var(--status-fg);
    font-weight:700;
    font-size:11px;
    padding:6px 8px;
    border-radius:999px;
    box-shadow:0 8px 18px rgba(0,0,0,0.22);
    text-transform:uppercase;
    z-index:6;
    white-space:nowrap;
  }

  /* right: hero & player */
  .hero {
    border-radius:14px; overflow:hidden; position:relative; margin-bottom:18px; min-height:220px;
    display:flex; align-items:center; gap:16px; padding:16px; border:1px solid rgba(255,255,255,0.02);
    background: linear-gradient(90deg, rgba(0,0,0,0.22), rgba(0,0,0,0.08));
  }
  .heroLeft{ width:280px; min-width:180px }
  .heroCover{ width:100%; height:160px; border-radius:10px; background:#07261a; overflow:hidden; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900 }
  .heroBody{ flex:1; color:inherit }
  .heroTitle{ font-weight:900; font-size:20px; color:#eaffef }
  .heroDesc{ color:var(--muted); margin-top:6px; max-width:700px }
  .heroActions{ margin-top:10px; display:flex; gap:10px }

  /* seasons */
  .seasonTabs{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap }
  .tab{ padding:8px 12px; border-radius:999px; background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); cursor:pointer }
  .tab.active{ background:var(--accent); color:white; border-color:transparent; box-shadow:0 8px 20px rgba(0,77,41,0.12) }

  /* stacked list */
  .stackList{ display:flex; flex-direction:column; gap:12px; margin-top:8px; }
  .stackRow{ display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.02); transition: box-shadow .18s ease; }
  .stackRow.highlight{ box-shadow: 0 12px 32px rgba(0,77,41,0.18); transform: translateY(-4px); }
  .stackThumb{ width:280px; height:158px; background:#07261a; border-radius:8px; flex-shrink:0; overflow:hidden; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900; position:relative }
  .stackThumb img{ width:100%; height:100%; object-fit:cover; display:block }
  .stackMeta{ flex:1; display:flex; flex-direction:column; gap:8px }
  .stackTitle{ font-weight:800; font-size:16px; color:#e9fff4 }
  .stackDesc{ color:var(--muted); font-size:13px }

  /* episode small badges */
  .epBadge{
    position:absolute;
    top:10px;
    left:10px;
    background:var(--badge-bg);
    color:var(--badge-fg);
    font-weight:800;
    font-size:11px;
    padding:6px 8px;
    border-radius:999px;
    box-shadow:0 8px 18px rgba(0,0,0,0.36);
    text-transform:uppercase;
    z-index:6;
    white-space:nowrap;
  }
  .epComing{
    position:absolute;
    top:10px;
    left:10px;
    background:rgba(255,255,255,0.08);
    color:var(--muted);
    font-weight:700;
    font-size:11px;
    padding:6px 8px;
    border-radius:999px;
    z-index:6;
    white-space:nowrap;
  }

  /* play badge */
  .playBadge{ background:var(--accent); width:38px; height:38px; border-radius:999px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; box-shadow:0 8px 18px rgba(0,77,41,0.16) }

  /* player area */
  .playerArea{ margin-bottom:18px; border-radius:12px; background:#02130d; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,0.6) }
  .playerFrame{ width:100%; border-radius:10px; overflow:hidden; background:black; min-height:280px; display:flex; align-items:center; justify-content:center }
  .playerFrame iframe, .playerFrame video{ width:100%; height:100%; border:0; display:block }

  .noResults { color:var(--muted); padding:18px; text-align:center }

  @media (min-width:1100px){
    .homeGrid { grid-template-columns: repeat(3, 1fr); }
    .cardImage { padding-top:160%; }
  }
  @media (max-width:1099px) and (min-width:700px){
    .homeGrid { grid-template-columns: repeat(2, 1fr); }
    .cardImage { padding-top:150%; }
  }
  @media (max-width:699px){
    .homeGrid { grid-template-columns: 1fr; }
    .cardImage { padding-top:120%; }
    .heroLeft{ width:140px }
    .heroCover{ height:110px }
    /* mobile: stack episode rows vertically */
    .stackRow{ flex-direction:column; align-items:stretch }
    .stackThumb{ width:100%; height:190px }
  }
  @media (max-width:420px){
    .cardFooter .title{ font-size:20px }
  }
</style>
</head>
<body>

<!-- Welcome -->
<div id="welcome" role="dialog" aria-modal="true">
  <div class="logoLarge" id="welcomeLogoWrap">
    <img id="welcomeLogo" src="" alt="logo" style="display:none" />
    <span id="welcomeLetter" style="font-weight:900;font-size:36px;display:block">W+</span>
  </div>
  <h1>Welcome to WOB WATCH+</h1>
  <p>Stream iconic series created or sponsored by World Of Bloxburg.</p>
  <button class="startBtn" id="welcomeStartBtn" onclick="enterApp()">Start Watching</button>
</div>

<!-- HEADER -->
<div class="topbar">
  <div id="logo" title="WOB WATCH+">
    <img id="logoImg" src="" alt="" style="display:none" />
    <span id="logoLetter">W+</span>
  </div>
  <div class="brand"><div class="title">WOB WATCH+</div><div class="sub">Stream the content on WOB WATCH Plus</div></div>
  <div class="header-actions">
    <input id="globalSearchInput" placeholder="Search series, episodes..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
    <div id="seriesCount" style="color:var(--muted);font-size:13px;margin-right:6px">0 total</div>
    <button class="ghost" id="homeBtn">Home</button>
  </div>
</div>

<main>
  <div class="layout">

    <!-- SEARCH RESULTS (hidden unless searching) -->
    <div id="searchResults" class="searchResults" style="display:none">
      <div class="searchHeader">
        <div><strong>Search results</strong></div>
        <div class="count" id="searchCount">0 results</div>
      </div>
      <div id="resultsArea"></div>
    </div>

    <!-- HOME GRID (shows first) -->
    <div id="homeGrid" class="homeGrid" aria-live="polite"></div>

    <!-- hero (hidden when home grid visible) -->
    <div id="hero" class="hero" style="display:none">
      <div class="heroLeft"><div id="heroCover" class="heroCover">COVER</div></div>
      <div class="heroBody">
        <div id="heroTitle" class="heroTitle">Show title</div>
        <div id="heroDesc" class="heroDesc">Show description</div>
        <div class="heroActions">
          <button class="btn" id="heroPlay">Play</button>
        </div>
      </div>
    </div>

    <!-- player -->
    <div id="playerArea" class="playerArea" style="display:none" aria-live="polite">
      <div class="playerFrame" id="playerFrame"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div id="playerMeta" style="color:var(--muted)"></div>
        <div style="display:flex;gap:8px"></div>
      </div>
    </div>

    <!-- season tabs -->
    <div id="seasonTabs" class="seasonTabs" style="display:none"></div>

    <!-- episodes list -->
    <div id="episodesContainer" style="display:none">
      <div id="episodesList" class="stackList"></div>
    </div>

  </div>
</main>

<div style="text-align:center;color:var(--muted);padding:18px;font-size:13px">WOB WATCH+ — made with ❤️</div>

<script>
/* ==========================
   v1.1 updates:
   - Better search results UI
   - Image fallback safety
   - Mobile layout fixes for episodes/hero
   - Episode badges: 'new' and 'coming' support
   - Prev/Next and Autoplay removed as requested
*/

/* -------------------------
   CONTENT: edit only inside this block
   (season/episode titles & descriptions restored to your original)
*/
const CONTENT = [
  {
    id: 'bdr',
    name: "Bloxburg's Drag Race",
    desc: "Stream the original series on WOB WATCH+",
    cover: 'BDRCOVER.png',
    coverB: 'BDRCOVER_B.png',
    badge: 'New Episodes Weekly',
    show: true,
    seasons: [
      { id:'s1', title:'Season 1', show: true, episodes:[
          { id:'s1e1', title:'Episode 1 - Who Is She?', desc:'Meet our SICKENING cast of 6 in our Spectacular Premiere!', thumbnail:'BDRS1E1COVER.png', videoUrl:'https://iframe.videodelivery.net/6d292286ad9b7d8c02b2bd2c7361f376', show: true },
          { id:'s1e2', title:'Episode 2 - Charisma, Uniqueness, Nerve… and Cooking!', desc:'The queens split, to form and host 2 Draggy Cooking shows.', thumbnail:'BDRS1E2COVER.png', videoUrl:'https://iframe.videodelivery.net/08cf9d1878f4cbfa7788082c0abbc2d9', show: true },
          { id:'s1e3', title:'Episode 3 - Black & White', desc:'The queens have 10 minutes to design a Black and White outfit.', thumbnail:'BDRS1E3COVER.png', videoUrl:'https://iframe.videodelivery.net/09f91852097a7ffeeb01979bb751ac98', show: true },
          { id:'s1e4', title:'Episode 4 - The Snatch Game', desc:'The queens play the infamous snatch game!', thumbnail:'BDRS1E4COVER.png', videoUrl:'https://iframe.videodelivery.net/c91b89c3c6ba633636482a92f1e045fd', show: true },
          { id:'s1e5', title:'Episode 5 - The Evil Roast', desc:'The queens must create a Roast performance, roasting their fellow queens along with the judges. This is their last change to earn a spot in next weeks grand finale!', thumbnail:'BDRS1E5COVER.png', videoUrl:'https://iframe.videodelivery.net/ff8fd61b4776e22608f9fe65d1cbe94f', show: true },
          { id:'s1e6', title:'Episode 6 - The Grand Finale', desc:'The Top 3 is made into a Top 2, and a Winner is Crowned!', thumbnail:'BDRS1E6COVER.png', videoUrl:'https://iframe.videodelivery.net/034da72e1d1278b3b9df97349db0981f', show: true }
      ]},
      { id:'s2', title:'Season 2', show: true, episodes:[
          { id:'s2e1', title:'Episode 1 - Rags To Riches', desc:'A brand new cast of 5 fierce queens enter the werk room, and are greeted by a ball!', thumbnail:'BDRS2E1COVER.png', videoUrl:'https://iframe.videodelivery.net/a9649e43d79a240d4a2a0138f0655238', show: true, badge: 'NEW' },
          { id:'s2e2', title:'Episode 2 - The Traitors Tea', desc:'Episode releases on January 21st, 17:00 GMT on YouTube. Watch the episode here from 18:00 GMT!', thumbnail:'BDRS2E2COVER.png', videoUrl:'', show: true }
      ]},
      { id:'s3', title:'Season 3', show: false, episodes:[
          { id:'s3e1', title:'', desc:'', thumbnail:'BDRS3E1COVER.png', videoUrl:'https://iframe.videodelivery.net/a9649e43d79a240d4a2a0138f0655238', show: true }
      ]}
    ]
  },
  {
    id:'show2',
    name:'Iconic Lip Syncs',
    desc:'Shorts and extras.',
    cover:'ICONICLIPSYNCSCOVER.png',
    show: false,
    seasons:[
      { id:'ss1', title:'Season 1', show: true, episodes:[
        { id:'ss1e1', title:'Short 1', desc:'A little clip', thumbnail:'WOBS1E1COVER.png', videoUrl:'', show: true }
      ]}
    ]
  }
];
/* ========================== */

const qs = id => document.getElementById(id);
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* small local helper to create an <img> with fallback to a placeholder
   - images are positioned absolute so they won't push the wrapper taller
*/
function makeImgWithFallback(src, altText, placeholderText){
  const img = document.createElement('img');
  img.src = src || '';
  img.alt = altText || '';
  // ensure it fills any aspect-ratio wrapper safely
  img.style.position = 'absolute';
  img.style.top = '0';
  img.style.left = '0';
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  // fallback: hide broken image and inject placeholder element
  img.onerror = function(){
    img.style.display = 'none';
    const parent = img.parentNode;
    if(!parent) return;
    // if placeholder already exists, skip
    if(parent.querySelector('.cardPlaceholder') || parent.querySelector('.thumbPlaceholder')) return;
    const ph = document.createElement('div');
    // choose placeholder class based on container
    ph.className = parent.classList.contains('cardImage') ? 'cardPlaceholder' : 'thumbPlaceholder';
    ph.style.display = 'flex'; ph.style.alignItems = 'center'; ph.style.justifyContent = 'center';
    ph.style.width = '100%'; ph.style.height = '100%';
    ph.textContent = placeholderText || (altText||'').slice(0,2).toUpperCase();
    parent.appendChild(ph);
  };
  return img;
}

/* load logo.png into header and welcome; fallback to letter */
function loadLogo(){
  const headerImg = qs('logoImg'), headerLetter = qs('logoLetter');
  const welcomeImg = qs('welcomeLogo'), welcomeLetter = qs('welcomeLetter');
  if(headerImg){
    headerImg.src = 'logo.png';
    headerImg.onload = ()=>{ headerImg.style.display='block'; if(headerLetter) headerLetter.style.display='none'; };
    headerImg.onerror = ()=>{ headerImg.style.display='none'; if(headerLetter) headerLetter.style.display='block'; };
  }
  if(welcomeImg){
    welcomeImg.src = 'logo.png';
    welcomeImg.onload = ()=>{ welcomeImg.style.display='block'; if(welcomeLetter) welcomeLetter.style.display='none'; };
    welcomeImg.onerror = ()=>{ welcomeImg.style.display='none'; if(welcomeLetter) welcomeLetter.style.display='block'; };
  }
}

/* ---------- core UI render & logic ---------- */
let CURRENT = { seriesId:null, seasonId:null, episodeId:null };

/* visible series helper */
function visibleSeriesList(){ return Array.isArray(CONTENT) ? CONTENT.filter(s => s.show !== false) : []; }

/* Render home grid (only visible series) */
function renderHomeGrid(){
  const root = qs('homeGrid'); if(!root) return;
  root.innerHTML = '';
  const visible = visibleSeriesList();
  visible.forEach(s=>{
    const card = document.createElement('div'); card.className='card';
    card.addEventListener('click', ()=> { showSeriesFromCard(s.id); });

    // image area
    const imgWrap = document.createElement('div'); imgWrap.className='cardImage';
    if(s.cover){
      const img = makeImgWithFallback(s.cover, s.name, (s.name||'').slice(0,2).toUpperCase());
      imgWrap.appendChild(img);
    } else {
      const ph = document.createElement('div'); ph.className='cardPlaceholder'; ph.textContent = (s.name||'').slice(0,2).toUpperCase();
      imgWrap.appendChild(ph);
    }

    // badge on the card (centered)
    if(s.badge){
      const b = document.createElement('div');
      b.className = 'showBadge';
      b.textContent = s.badge;
      b.setAttribute('aria-hidden','true');
      imgWrap.appendChild(b);
    }

    // footer band (green) - show only count of visible seasons
    const visibleSeasons = (Array.isArray(s.seasons) ? s.seasons.filter(se=> se.show !== false) : []);
    const footer = document.createElement('div'); footer.className='cardFooter';
    const t = document.createElement('div'); t.className='title'; t.textContent = s.name || 'Untitled';
    const sub = document.createElement('div'); sub.className='sub';
    const seasonCount = visibleSeasons.length;
    sub.textContent = seasonCount + (seasonCount === 1 ? ' Season' : ' Seasons');
    footer.appendChild(t); footer.appendChild(sub);

    card.appendChild(imgWrap); card.appendChild(footer);
    root.appendChild(card);
  });
}

/* ========= Search results UI ========= */
function renderSearchResults(query){
  const resultsArea = qs('resultsArea');
  const resultsWrapper = qs('searchResults');
  if(!resultsArea || !resultsWrapper) return;
  const q = (query||'').trim().toLowerCase();
  if(!q){ resultsWrapper.style.display = 'none'; return; }

  // hide other large UI elements while searching
  qs('homeGrid').style.display = 'none';
  qs('hero').style.display = 'none';
  qs('seasonTabs').style.display = 'none';
  qs('episodesContainer').style.display = 'none';
  qs('playerArea').style.display = 'none';

  resultsWrapper.style.display = 'block';
  resultsArea.innerHTML = '';

  const seriesMatches = visibleSeriesList().filter(s=> (s.name||'').toLowerCase().includes(q) || (s.desc||'').toLowerCase().includes(q));
  const episodeMatches = [];

  // search episodes across visible seasons & visible series
  for(const s of visibleSeriesList()){
    const seasons = Array.isArray(s.seasons) ? s.seasons.filter(se=> se.show !== false) : [];
    for(const se of seasons){
      for(const ep of (Array.isArray(se.episodes) ? se.episodes : [])){
        if(ep.show === false) continue;
        const hay = ((ep.title||'') + ' ' + (ep.desc||'')).toLowerCase();
        if(hay.includes(q)){
          episodeMatches.push({ series: s, season: se, episode: ep });
        }
      }
    }
  }

  const total = seriesMatches.length + episodeMatches.length;
  const countEl = qs('searchCount'); if(countEl) countEl.textContent = total + ' result' + (total===1?'':'s');

  // series results (grid)
  if(seriesMatches.length){
    const sTitle = document.createElement('div'); sTitle.style.fontWeight='800'; sTitle.style.margin='6px 0'; sTitle.textContent = 'Series';
    resultsArea.appendChild(sTitle);
    const grid = document.createElement('div'); grid.className = 'resultsGrid';
    seriesMatches.forEach(s=>{
      const mini = document.createElement('div'); mini.style.cursor='pointer';
      mini.style.borderRadius='12px'; mini.style.overflow='hidden'; mini.style.background='linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
      mini.style.padding='8px';
      mini.addEventListener('click', ()=>{ renderSeriesContent(s.id); qs('homeGrid').style.display='none'; qs('hero').style.display='flex'; qs('seasonTabs').style.display='flex'; qs('episodesContainer').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); });
      const imgWrap = document.createElement('div'); imgWrap.style.width='100%'; imgWrap.style.paddingTop='60%'; imgWrap.style.position='relative'; imgWrap.style.marginBottom='10px'; imgWrap.style.overflow='hidden'; imgWrap.style.borderRadius='8px';
      if(s.cover){
        const img = makeImgWithFallback(s.cover, s.name, (s.name||'').slice(0,2).toUpperCase());
        // ensure the image sits absolutely inside the preview box (prevents layout blowout)
        img.style.position = 'absolute';
        img.style.top = '0';
        img.style.left = '0';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        imgWrap.appendChild(img);
      } else {
        const ph = document.createElement('div'); ph.className='thumbPlaceholder'; ph.textContent = (s.name||'').slice(0,2).toUpperCase(); ph.style.height='100%';
        imgWrap.appendChild(ph);
      }
      const title = document.createElement('div'); title.style.fontWeight='800'; title.style.marginBottom='4px'; title.textContent = s.name;
      const sub = document.createElement('div'); sub.style.color='var(--muted)'; sub.style.fontSize='13px'; sub.textContent = s.desc || '';
      mini.appendChild(imgWrap); mini.appendChild(title); mini.appendChild(sub);
      grid.appendChild(mini);
    });
    resultsArea.appendChild(grid);
  }

  // episode results (stack)
  if(episodeMatches.length){
    const eTitle = document.createElement('div'); eTitle.style.fontWeight='800'; eTitle.style.margin='12px 0 6px'; eTitle.textContent = 'Episodes';
    resultsArea.appendChild(eTitle);
    const list = document.createElement('div');
    episodeMatches.forEach(rec=>{
      const box = document.createElement('div'); box.style.display='flex'; box.style.gap='12px'; box.style.alignItems='center'; box.style.padding='8px 6px'; box.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      box.style.cursor='pointer';
      box.addEventListener('click', ()=>{
        // open the series and season, then highlight the episode row
        renderSeriesContent(rec.series.id);
        qs('homeGrid').style.display = 'none';
        qs('hero').style.display = 'flex';
        qs('seasonTabs').style.display = 'flex';
        qs('episodesContainer').style.display = 'block';
        // ensure tabs and season rendered
        setTimeout(()=>{
          renderSeason(rec.series.id, rec.season.id);
          const row = qs('ep-'+rec.episode.id);
          if(row){
            row.classList.add('highlight');
            row.scrollIntoView({behavior:'smooth', block:'center'});
            setTimeout(()=> row.classList.remove('highlight'), 2500);
          }
        }, 60);
      });

      const th = document.createElement('div'); th.style.width='96px'; th.style.height='56px'; th.style.flex='0 0 96px'; th.style.position='relative'; th.style.overflow='hidden'; th.style.borderRadius='6px';
      if(rec.episode.thumbnail){
        const img = makeImgWithFallback(rec.episode.thumbnail, rec.episode.title || '', (rec.episode.title||'').slice(0,2).toUpperCase());
        img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
        // absolute positioning already set in helper
        th.appendChild(img);
      } else {
        const ph = document.createElement('div'); ph.className='thumbPlaceholder'; ph.textContent = (rec.episode.title||'').slice(0,2).toUpperCase();
        ph.style.width='96px'; ph.style.height='56px';
        th.appendChild(ph);
      }

      const meta = document.createElement('div'); meta.style.flex='1';
      const t = document.createElement('div'); t.style.fontWeight='800'; t.textContent = rec.episode.title || 'Episode';
      const s = document.createElement('div'); s.style.color='var(--muted)'; s.style.fontSize='13px'; s.textContent = rec.series.name + ' — ' + rec.season.title;
      meta.appendChild(t); meta.appendChild(s);
      box.appendChild(th); box.appendChild(meta);
      list.appendChild(box);
    });
    resultsArea.appendChild(list);
  }

  if(total === 0){
    resultsArea.innerHTML = '<div class="noResults">No results found</div>';
  }
}

/* show/hide home and series UI */
function showHome(){
  qs('searchResults').style.display = 'none';
  qs('homeGrid').style.display = 'grid';
  qs('hero').style.display = 'none';
  qs('seasonTabs').style.display = 'none';
  qs('episodesContainer').style.display = 'none';
  qs('playerArea').style.display = 'none';
  window.scrollTo({top:0, behavior:'smooth'});
}
function showSeriesFromCard(seriesId){
  renderSeriesContent(seriesId);
  qs('homeGrid').style.display = 'none';
  qs('hero').style.display = 'flex';
  qs('seasonTabs').style.display = 'flex';
  qs('episodesContainer').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* Render series content into hero/season/episodes */
function renderSeriesContent(seriesId){
  const s = CONTENT.find(x=>x.id===seriesId); if(!s) return;
  const heroImg = s.coverB || s.cover || '';

  // set hero image (with fallback)
  qs('heroCover').innerHTML = '';
  if(heroImg){
    const wrapper = qs('heroCover');
    const img = makeImgWithFallback(heroImg, s.name, (s.name||'').slice(0,2).toUpperCase());
    img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
    wrapper.appendChild(img);
  } else {
    qs('heroCover').textContent = (s.name||'').slice(0,2).toUpperCase();
  }

  // remove previous badges/status
  const existingBadge = qs('heroCover').querySelector('.heroBadge');
  if(existingBadge) existingBadge.remove();
  const existingStatus = qs('heroCover').querySelector('.heroStatusBadge');
  if(existingStatus) existingStatus.remove();

  // hero badge (if provided by content)
  if(s.badge && s.show !== false){
    const hb = document.createElement('div');
    hb.className = 'heroBadge';
    hb.textContent = s.badge;
    hb.setAttribute('aria-hidden','true');
    qs('heroCover').appendChild(hb);
  }

  // If series is hidden, show status badge and prevent playback/tabs
  if(s.show === false){
    const status = document.createElement('div');
    status.className = 'heroStatusBadge';
    status.textContent = 'Unpublished';
    status.setAttribute('aria-hidden','true');
    qs('heroCover').appendChild(status);
  }

  qs('heroTitle').textContent = s.name;
  qs('heroDesc').textContent = s.desc || '';

  const visibleSeasons = (Array.isArray(s.seasons) ? s.seasons.filter(se=> se.show !== false) : []);
  const tabs = qs('seasonTabs'); if(!tabs) return; tabs.innerHTML='';

  if(s.show === false){
    qs('seasonTabs').style.display = 'none';
    qs('episodesContainer').style.display = 'none';
    qs('heroPlay').disabled = true;
  } else if(visibleSeasons.length === 0){
    qs('seasonTabs').style.display = 'none';
    qs('episodesContainer').style.display = 'none';
    qs('heroPlay').disabled = true;
  } else {
    visibleSeasons.forEach((se, idx)=>{
      const b = document.createElement('button'); b.className='tab'; b.textContent = se.title;
      b.addEventListener('click', ()=> { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderSeason(seriesId, se.id); });
      if(idx===0) b.classList.add('active');
      tabs.appendChild(b);
    });
    qs('seasonTabs').style.display = 'flex';
    qs('episodesContainer').style.display = 'block';
    qs('heroPlay').disabled = false;
    renderSeason(seriesId, visibleSeasons[0].id);
  }

  CURRENT.seriesId = seriesId;
}

/* season + episodes rendering */
function renderSeason(seriesId, seasonId){
  const s = CONTENT.find(x=>x.id===seriesId); if(!s) return;
  const season = (Array.isArray(s.seasons) ? s.seasons.find(x=>x.id===seasonId && x.show !== false) : null);
  const el = qs('episodesList'); if(!el) return; el.innerHTML = '';
  if(!season){ el.innerHTML = '<div style="color:var(--muted)">No episodes</div>'; return; }

  const visibleEpisodes = Array.isArray(season.episodes) ? season.episodes.filter(ep => ep.show !== false) : [];
  if(visibleEpisodes.length === 0){
    el.innerHTML = '<div style="color:var(--muted)">No published episodes in this season</div>';
    CURRENT.seriesId = seriesId; CURRENT.seasonId = seasonId; CURRENT.episodeId = null;
    return;
  }

  visibleEpisodes.forEach((ep, idx)=>{
    const titleDisplay = ep.title && ep.title.trim() ? ep.title : `Episode ${idx+1}`;
    const row = document.createElement('div'); row.className='stackRow'; row.id = 'ep-'+ep.id;

    // thumbnail area
    const thumbWrap = document.createElement('div'); thumbWrap.className = 'stackThumb'; thumbWrap.style.position = 'relative';
    if(ep.thumbnail){
      const img = makeImgWithFallback(ep.thumbnail, titleDisplay, titleDisplay.slice(0,2).toUpperCase());
      thumbWrap.appendChild(img);
    } else {
      const placeholder = document.createElement('div'); placeholder.className='cardPlaceholder'; placeholder.textContent = titleDisplay.slice(0,2).toUpperCase();
      thumbWrap.appendChild(placeholder);
    }

    // episode-level badge: 'new' or 'coming'
    // NORMALIZE badge string (case-insensitive)
    const badgeVal = (ep.badge || '').toString().trim().toLowerCase();
    if(badgeVal === 'new'){
      const eb = document.createElement('div'); eb.className = 'epBadge'; eb.textContent = 'NEW'; thumbWrap.appendChild(eb);
    } else if(badgeVal === 'coming' || !ep.videoUrl){
      const ec = document.createElement('div'); ec.className = 'epComing'; ec.textContent = 'Coming soon'; thumbWrap.appendChild(ec);
    }

    const badge = document.createElement('div'); badge.style.position='absolute'; badge.style.right='12px'; badge.style.bottom='12px';
    const badgeInner = document.createElement('div'); badgeInner.className='playBadge'; badgeInner.textContent = ep.videoUrl ? '▶' : '⎯';
    badge.appendChild(badgeInner); thumbWrap.appendChild(badge);

    // meta column
    const meta = document.createElement('div'); meta.className='stackMeta';
    const metaTop = document.createElement('div'); metaTop.style.display='flex'; metaTop.style.gap='12px'; metaTop.style.alignItems='flex-start';
    const metaLeft = document.createElement('div'); metaLeft.style.flex = '1';
    const titleEl = document.createElement('div'); titleEl.className = 'stackTitle'; titleEl.textContent = titleDisplay;
    const descEl = document.createElement('div'); descEl.className = 'stackDesc'; descEl.textContent = ep.desc || '';
    metaLeft.appendChild(titleEl); metaLeft.appendChild(descEl);

    metaTop.appendChild(metaLeft);

    const actions = document.createElement('div'); actions.style.marginTop = '10px';
    if(ep.videoUrl && badgeVal !== 'coming'){
      const pbtn = document.createElement('button'); pbtn.className='btn'; pbtn.textContent='Play';
      pbtn.addEventListener('click', ()=> playEpisode(seriesId, seasonId, ep.id));
      actions.appendChild(pbtn);
    } else {
      const ghost = document.createElement('button'); ghost.className='ghost'; ghost.textContent='Coming soon'; ghost.disabled = true;
      actions.appendChild(ghost);
    }

    meta.appendChild(metaTop); meta.appendChild(actions);

    row.appendChild(thumbWrap); row.appendChild(meta);
    el.appendChild(row);
  });

  CURRENT.seriesId = seriesId; CURRENT.seasonId = seasonId; CURRENT.episodeId = null;
}

/* Robust showPlayer: supports YouTube, Cloudflare iframe, HLS (.m3u8 via hls.js), direct mp4/webm */
function showPlayer(url, title, subtitle){
  const frame = qs('playerFrame'); if(!frame) return;
  frame.innerHTML = '';
  qs('playerMeta').textContent = subtitle || '';
  qs('heroTitle').textContent = title || qs('heroTitle').textContent;

  const cfIframe = normalizeCloudflareIframe(url);
  const isYouTube = (u) => !!toYouTubeEmbed(u);
  const isM3U8 = (u) => typeof u === 'string' && /\.m3u8(\?|$)/i.test(u);
  const isDirectVideo = (u) => typeof u === 'string' && /\.(mp4|webm|ogg)(\?|$)/i.test(u);

  if(isYouTube(url)){
    const yt = toYouTubeEmbed(url);
    const wrap = document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%'; wrap.style.paddingTop='56.25%';
    const ifr = document.createElement('iframe');
    ifr.src = yt + '&autoplay=1';
    ifr.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
    ifr.style.position='absolute'; ifr.style.top='0'; ifr.style.left='0'; ifr.style.width='100%'; ifr.style.height='100%'; ifr.style.border='0';
    wrap.appendChild(ifr); frame.appendChild(wrap);

  } else if(cfIframe){
    const wrap = document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%'; wrap.style.paddingTop='56.25%';
    const ifr = document.createElement('iframe');
    ifr.src = cfIframe + (cfIframe.includes('?') ? '&' : '?') + 'autoplay=1';
    ifr.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen';
    ifr.setAttribute('allowfullscreen','');
    ifr.style.position='absolute'; ifr.style.top='0'; ifr.style.left='0'; ifr.style.width='100%'; ifr.style.height='100%'; ifr.style.border='0';
    wrap.appendChild(ifr); frame.appendChild(wrap);

  } else if(isM3U8(url)){
    const video = document.createElement('video');
    video.controls = true; video.style.width='100%'; video.style.height='100%';
    frame.appendChild(video);
    if(window.Hls && Hls.isSupported()){
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play().catch(()=>{}); });
    } else {
      video.src = url;
      video.play().catch(()=>{});
    }

  } else if(isDirectVideo(url)){
    const video = document.createElement('video');
    video.controls = true; video.src = url; video.style.width='100%'; video.style.height='100%';
    frame.appendChild(video);
    video.play().catch(()=>{});

  } else if(typeof url === 'string' && url.trim()){
    const wrap = document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%'; wrap.style.paddingTop='56.25%';
    const ifr = document.createElement('iframe');
    ifr.src = url;
    ifr.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
    ifr.style.position='absolute'; ifr.style.top='0'; ifr.style.left='0'; ifr.style.width='100%'; ifr.style.height='100%'; ifr.style.border='0';
    wrap.appendChild(ifr); frame.appendChild(wrap);

  } else {
    frame.innerHTML = '<div style="padding:28px;color:var(--muted)">No playable video found for this episode.</div>';
  }

  qs('playerArea').style.display='block';
  if(window.innerWidth < 900) qs('playerArea').scrollIntoView({behavior:'smooth'});
}

/* next / prev helpers (kept for possible future use) */
function findNext(seriesId, seasonId, episodeId){
  const s = CONTENT.find(x=>x.id===seriesId); if(!s) return null;
  const seasons = s.seasons || []; const si = seasons.findIndex(x=>x.id===seasonId); if(si === -1) return null;
  const se = seasons[si]; const ei = se.episodes.findIndex(x=>x.id===episodeId); if(ei === -1) return null;
  if(ei + 1 < se.episodes.length) return { seriesId, seasonId, episodeId: se.episodes[ei+1].id };
  for(let j=si+1;j<seasons.length;j++){ const ns = seasons[j]; if(ns.episodes && ns.episodes.length) return { seriesId, seasonId: ns.id, episodeId: ns.episodes[0].id }; }
  return null;
}
function findPrev(seriesId, seasonId, episodeId){
  const s = CONTENT.find(x=>x.id===seriesId); if(!s) return null;
  const seasons = s.seasons || []; const si = seasons.findIndex(x=>x.id===seasonId); if(si === -1) return null;
  const se = seasons[si]; const ei = se.episodes.findIndex(x=>x.id===episodeId); if(ei === -1) return null;
  if(ei - 1 >= 0) return { seriesId, seasonId, episodeId: se.episodes[ei-1].id };
  for(let j=si-1;j>=0;j--){ const ps = seasons[j]; if(ps.episodes && ps.episodes.length) return { seriesId, seasonId: ps.id, episodeId: ps.episodes[ps.episodes.length-1].id }; }
  return null;
}
function playNext(){ if(!CURRENT.episodeId) return; const nxt = findNext(CURRENT.seriesId, CURRENT.seasonId, CURRENT.episodeId); if(nxt) playEpisode(nxt.seriesId, nxt.seasonId, nxt.episodeId); else alert('No next episode'); }
function playPrev(){ if(!CURRENT.episodeId) return; const prev = findPrev(CURRENT.seriesId, CURRENT.seasonId, CURRENT.episodeId); if(prev) playEpisode(prev.seriesId, prev.seasonId, prev.episodeId); else alert('No previous episode'); }

/* hero play - first available in first (visible) season & episode */
function heroPlay(){
  const s = CONTENT.find(x=>x.id===CURRENT.seriesId) || CONTENT[0];
  if(!s || s.show === false) { alert('This series is unpublished'); return; }
  const visibleSeasons = (Array.isArray(s.seasons) ? s.seasons.filter(se=>se.show !== false) : []);
  if(!visibleSeasons.length) { alert('No episodes yet'); return; }
  const se = visibleSeasons[0];
  const visibleEpisodes = Array.isArray(se.episodes) ? se.episodes.filter(ep => ep.show !== false && ( (ep.badge||'').toString().trim().toLowerCase() !== 'coming')) : [];
  if(!visibleEpisodes.length) { alert('No published episodes in this season'); return; }
  const ep = visibleEpisodes.find(e=>e.videoUrl) || visibleEpisodes[0];
  if(!ep.videoUrl){ alert('No video attached to this show yet'); return; }
  playEpisode(s.id,se.id,ep.id);
}

/* search (skips hidden content) */
function globalSearch(){
  const q = (qs('globalSearchInput') && qs('globalSearchInput').value || '').trim();
  if(!q){ showHome(); return; }
  renderSearchResults(q);
}

/* goHome */
function goHome(){ showHome(); }

/* enter app (welcome) */
function enterApp(){ const w = qs('welcome'); if(!w) return; w.classList.add('hide-welcome'); setTimeout(()=>{ if(w && w.parentNode) w.parentNode.removeChild(w); },400); }

/* playEpisode (public) */
function playEpisode(seriesId, seasonId, episodeId){
  const s = CONTENT.find(x=>x.id===seriesId); if(!s || s.show === false) { alert('This series is unpublished'); return; }
  const se = (Array.isArray(s.seasons)?s.seasons:[]).find(x=>x.id===seasonId && x.show !== false); if(!se) return;
  const ep = (Array.isArray(se.episodes)?se.episodes:[]).find(x=>x.id===episodeId && x.show !== false); if(!ep) return;
  if((ep.badge||'').toString().trim().toLowerCase() === 'coming' || !ep.videoUrl){ alert('This episode is not available yet'); return; }
  const url = ep.videoUrl || ep.videoData || '';
  if(!url){ alert('No video attached for this episode'); return; }
  CURRENT = { seriesId, seasonId, episodeId };
  showPlayer(url, ep.title || `Episode`, `${s.name} — ${se.title}`);
  renderSeason(seriesId, seasonId);
}

/* small utility to get HTML5 video if present */
function currentVideoElement(){
  const frame = qs('playerFrame'); if(!frame) return null;
  const vid = frame.querySelector('video');
  return vid || null;
}

/* helper functions used by player/search */
function toYouTubeEmbed(url){
  if(!url || typeof url !== 'string') return null;
  try{
    const m = url.match(/(?:youtube\.com\/(?:.*v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{11})/);
    if(m && m[1]) return 'https://www.youtube.com/embed/' + m[1] + '?rel=0';
    try{ const u = new URL(url); const v = u.searchParams.get('v'); if(v) return 'https://www.youtube.com/embed/' + v + '?rel=0'; }catch(e){}
    return null;
  }catch(e){ return null; }
}
function normalizeCloudflareIframe(u){
  if(!u || typeof u !== 'string') return null;
  if(u.includes('iframe.videodelivery.net')) return u;
  const idMatch = u.match(/([a-f0-9]{32})/i);
  if(idMatch && idMatch[1]) return 'https://iframe.videodelivery.net/' + idMatch[1];
  return null;
}

/* init wiring */
(function init(){
  loadLogo();

  qs('globalSearchInput') && qs('globalSearchInput').addEventListener('input', globalSearch);
  qs('homeBtn') && qs('homeBtn').addEventListener('click', goHome);
  qs('heroPlay') && qs('heroPlay').addEventListener('click', heroPlay);
  qs('welcomeStartBtn') && qs('welcomeStartBtn').addEventListener('click', enterApp);

  try{
    renderHomeGrid();
    showHome();
    // header series count (visible only)
    const sc = qs('seriesCount'); if(sc) sc.textContent = visibleSeriesList().length + ' total';
  }catch(e){
    console.error('Init error', e);
  }

  // Spacebar toggles play/pause for the current visible <video> (ignore typing in inputs)
  document.addEventListener('keydown', function(ev){
    if(ev.code === 'Space' || ev.key === ' '){
      const active = document.activeElement;
      if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;
      const v = currentVideoElement();
      if(v){
        ev.preventDefault();
        if(v.paused) v.play().catch(()=>{}); else v.pause();
      }
    }
  });

  // Expose functions to window
  window.openSeries = renderSeriesContent;
  window.playEpisode = playEpisode;
  window.playNext = playNext;
  window.heroPlay = heroPlay;
  window.goHome = goHome;
  window.enterApp = enterApp;
  window.playPrev = playPrev;

  document.title = 'WOB WATCH+ — Stream';
})();
</script>
</body>
</html>
